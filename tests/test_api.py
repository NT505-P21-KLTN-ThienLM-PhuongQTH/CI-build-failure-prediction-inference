# tests/test_api.py
from fastapi.testclient import TestClient
from sqlalchemy import false, true

from main import app

client = TestClient(app)


def test_predict_endpoint():
    # Sample input
    input_data = {
      "model": "string",
      "status": "string",
      "ci_builds": [
         {
          "_id": "680e63cd9e247d8fde8df706",
          "git_branch": "main",
          "git_all_built_commits": "25e713ee6872383c70334e69e70a262d16108b40",
          "git_num_all_built_commits": 1,
          "git_trigger_commit": "25e713ee6872383c70334e69e70a262d16108b40",
          "git_diff_src_churn": 0,
          "git_diff_test_churn": 0,
          "gh_project_name": "NT548-P11-DevOps-Technology/class-management-lecturer-service",
          "gh_is_pr": false,
          "gh_lang": "python",
          "gh_team_size": 1,
          "gh_num_issue_comments": 0,
          "gh_num_pr_comments": 0,
          "gh_num_commit_comments": 0,
          "gh_diff_files_added": 0,
          "gh_diff_files_deleted": 0,
          "gh_diff_files_modified": 1,
          "gh_diff_tests_added": 0,
          "gh_diff_tests_deleted": 0,
          "gh_diff_src_files": 0,
          "gh_diff_doc_files": 0,
          "gh_diff_other_files": 1,
          "gh_num_commits_on_files_touched": 5,
          "gh_sloc": 75,
          "gh_test_lines_per_kloc": 0,
          "gh_test_cases_per_kloc": 0,
          "gh_asserts_cases_per_kloc": 0,
          "gh_by_core_team_member": true,
          "gh_repo_age": 210.73,
          "gh_repo_num_commits": 13,
          "build_duration": 206,
          "build_failed": "passed",
          "gh_build_started_at": "12/16/2024 18:46:42"
        },
        {
          "_id": "680e63cd9e247d8fde8df707",
          "git_branch": "stag",
          "git_all_built_commits": "25e713ee6872383c70334e69e70a262d16108b40",
          "git_num_all_built_commits": 1,
          "git_trigger_commit": "25e713ee6872383c70334e69e70a262d16108b40",
          "git_diff_src_churn": 0,
          "git_diff_test_churn": 0,
          "gh_project_name": "NT548-P11-DevOps-Technology/class-management-lecturer-service",
          "gh_is_pr": false,
          "gh_lang": "python",
          "gh_team_size": 1,
          "gh_num_issue_comments": 0,
          "gh_num_pr_comments": 0,
          "gh_num_commit_comments": 0,
          "gh_diff_files_added": 0,
          "gh_diff_files_deleted": 0,
          "gh_diff_files_modified": 1,
          "gh_diff_tests_added": 0,
          "gh_diff_tests_deleted": 0,
          "gh_diff_src_files": 0,
          "gh_diff_doc_files": 0,
          "gh_diff_other_files": 1,
          "gh_num_commits_on_files_touched": 5,
          "gh_sloc": 75,
          "gh_test_lines_per_kloc": 0,
          "gh_test_cases_per_kloc": 0,
          "gh_asserts_cases_per_kloc": 0,
          "gh_by_core_team_member": true,
          "gh_repo_age": 210.73,
          "gh_repo_num_commits": 13,
          "build_duration": 173,
          "build_failed": "passed",
          "gh_build_started_at": "12/16/2024 18:42:11"
        },
        {
          "_id": "680e63cd9e247d8fde8df708",
          "git_branch": "main",
          "git_all_built_commits": "e46e419b8d9857251eafeeb26fd8b3de9201c0dd",
          "git_num_all_built_commits": 1,
          "git_trigger_commit": "e46e419b8d9857251eafeeb26fd8b3de9201c0dd",
          "git_diff_src_churn": 0,
          "git_diff_test_churn": 0,
          "gh_project_name": "NT548-P11-DevOps-Technology/class-management-lecturer-service",
          "gh_is_pr": false,
          "gh_lang": "python",
          "gh_team_size": 1,
          "gh_num_issue_comments": 0,
          "gh_num_pr_comments": 0,
          "gh_num_commit_comments": 0,
          "gh_diff_files_added": 0,
          "gh_diff_files_deleted": 0,
          "gh_diff_files_modified": 1,
          "gh_diff_tests_added": 0,
          "gh_diff_tests_deleted": 0,
          "gh_diff_src_files": 0,
          "gh_diff_doc_files": 0,
          "gh_diff_other_files": 1,
          "gh_num_commits_on_files_touched": 4,
          "gh_sloc": 75,
          "gh_test_lines_per_kloc": 0,
          "gh_test_cases_per_kloc": 0,
          "gh_asserts_cases_per_kloc": 0,
          "gh_by_core_team_member": true,
          "gh_repo_age": 210.19,
          "gh_repo_num_commits": 12,
          "build_duration": 215,
          "build_failed": "passed",
          "gh_build_started_at": "12/15/2024 12:08:34"
        },
        {
          "_id": "680e63cd9e247d8fde8df709",
          "git_branch": "stag",
          "git_all_built_commits": "e46e419b8d9857251eafeeb26fd8b3de9201c0dd",
          "git_num_all_built_commits": 1,
          "git_trigger_commit": "e46e419b8d9857251eafeeb26fd8b3de9201c0dd",
          "git_diff_src_churn": 0,
          "git_diff_test_churn": 0,
          "gh_project_name": "NT548-P11-DevOps-Technology/class-management-lecturer-service",
          "gh_is_pr": false,
          "gh_lang": "python",
          "gh_team_size": 1,
          "gh_num_issue_comments": 0,
          "gh_num_pr_comments": 0,
          "gh_num_commit_comments": 0,
          "gh_diff_files_added": 0,
          "gh_diff_files_deleted": 0,
          "gh_diff_files_modified": 1,
          "gh_diff_tests_added": 0,
          "gh_diff_tests_deleted": 0,
          "gh_diff_src_files": 0,
          "gh_diff_doc_files": 0,
          "gh_diff_other_files": 1,
          "gh_num_commits_on_files_touched": 4,
          "gh_sloc": 75,
          "gh_test_lines_per_kloc": 0,
          "gh_test_cases_per_kloc": 0,
          "gh_asserts_cases_per_kloc": 0,
          "gh_by_core_team_member": true,
          "gh_repo_age": 210.19,
          "gh_repo_num_commits": 12,
          "build_duration": 319,
          "build_failed": "passed",
          "gh_build_started_at": "12/15/2024 10:51:05"
        },
        {
          "_id": "680e63cd9e247d8fde8df70a",
          "git_branch": "stag",
          "git_all_built_commits": "8d6392fa82dc805bcc6f2d36c743028afeee4033",
          "git_num_all_built_commits": 1,
          "git_trigger_commit": "8d6392fa82dc805bcc6f2d36c743028afeee4033",
          "git_diff_src_churn": 0,
          "git_diff_test_churn": 0,
          "gh_project_name": "NT548-P11-DevOps-Technology/class-management-lecturer-service",
          "gh_is_pr": false,
          "gh_lang": "python",
          "gh_team_size": 1,
          "gh_num_issue_comments": 0,
          "gh_num_pr_comments": 0,
          "gh_num_commit_comments": 0,
          "gh_diff_files_added": 0,
          "gh_diff_files_deleted": 0,
          "gh_diff_files_modified": 1,
          "gh_diff_tests_added": 0,
          "gh_diff_tests_deleted": 0,
          "gh_diff_src_files": 0,
          "gh_diff_doc_files": 0,
          "gh_diff_other_files": 1,
          "gh_num_commits_on_files_touched": 3,
          "gh_sloc": 75,
          "gh_test_lines_per_kloc": 0,
          "gh_test_cases_per_kloc": 0,
          "gh_asserts_cases_per_kloc": 0,
          "gh_by_core_team_member": true,
          "gh_repo_age": 210.19,
          "gh_repo_num_commits": 11,
          "build_duration": 0,
          "build_failed": "failed",
          "gh_build_started_at": "12/15/2024 10:48:39"
        },
        {
          "_id": "680e63cd9e247d8fde8df70b",
          "git_branch": "stag",
          "git_all_built_commits": "d0eea3999cc651b5f9510e38f2b885dcb09b4ddf",
          "git_num_all_built_commits": 1,
          "git_trigger_commit": "d0eea3999cc651b5f9510e38f2b885dcb09b4ddf",
          "git_diff_src_churn": 0,
          "git_diff_test_churn": 0,
          "gh_project_name": "NT548-P11-DevOps-Technology/class-management-lecturer-service",
          "gh_is_pr": false,
          "gh_lang": "python",
          "gh_team_size": 1,
          "gh_num_issue_comments": 0,
          "gh_num_pr_comments": 0,
          "gh_num_commit_comments": 0,
          "gh_diff_files_added": 0,
          "gh_diff_files_deleted": 0,
          "gh_diff_files_modified": 1,
          "gh_diff_tests_added": 0,
          "gh_diff_tests_deleted": 0,
          "gh_diff_src_files": 0,
          "gh_diff_doc_files": 0,
          "gh_diff_other_files": 1,
          "gh_num_commits_on_files_touched": 2,
          "gh_sloc": 75,
          "gh_test_lines_per_kloc": 0,
          "gh_test_cases_per_kloc": 0,
          "gh_asserts_cases_per_kloc": 0,
          "gh_by_core_team_member": true,
          "gh_repo_age": 209.22,
          "gh_repo_num_commits": 10,
          "build_duration": 122,
          "build_failed": "passed",
          "gh_build_started_at": "12/14/2024 11:28:55"
        },
        {
          "_id": "680e63cd9e247d8fde8df70c",
          "git_branch": "main",
          "git_all_built_commits": "3899e6e9bb94dce18460d35d288f52756fc2ad35",
          "git_num_all_built_commits": 1,
          "git_trigger_commit": "3899e6e9bb94dce18460d35d288f52756fc2ad35",
          "git_diff_src_churn": 0,
          "git_diff_test_churn": 0,
          "gh_project_name": "NT548-P11-DevOps-Technology/class-management-lecturer-service",
          "gh_is_pr": false,
          "gh_lang": "python",
          "gh_team_size": 1,
          "gh_num_issue_comments": 0,
          "gh_num_pr_comments": 0,
          "gh_num_commit_comments": 0,
          "gh_diff_files_added": 0,
          "gh_diff_files_deleted": 0,
          "gh_diff_files_modified": 1,
          "gh_diff_tests_added": 0,
          "gh_diff_tests_deleted": 0,
          "gh_diff_src_files": 0,
          "gh_diff_doc_files": 0,
          "gh_diff_other_files": 1,
          "gh_num_commits_on_files_touched": 1,
          "gh_sloc": 75,
          "gh_test_lines_per_kloc": 0,
          "gh_test_cases_per_kloc": 0,
          "gh_asserts_cases_per_kloc": 0,
          "gh_by_core_team_member": true,
          "gh_repo_age": 209.22,
          "gh_repo_num_commits": 9,
          "build_duration": 86,
          "build_failed": "passed",
          "gh_build_started_at": "12/14/2024 11:26:32"
        },
        {
          "_id": "680e63cd9e247d8fde8df70d",
          "git_branch": "main",
          "git_all_built_commits": "6c831ca5f64109da53c34774c7a45e1b93fcd4b6",
          "git_num_all_built_commits": 1,
          "git_trigger_commit": "6c831ca5f64109da53c34774c7a45e1b93fcd4b6",
          "git_diff_src_churn": 0,
          "git_diff_test_churn": 0,
          "gh_project_name": "NT548-P11-DevOps-Technology/class-management-lecturer-service",
          "gh_is_pr": false,
          "gh_lang": "python",
          "gh_team_size": 1,
          "gh_num_issue_comments": 0,
          "gh_num_pr_comments": 0,
          "gh_num_commit_comments": 0,
          "gh_diff_files_added": 0,
          "gh_diff_files_deleted": 0,
          "gh_diff_files_modified": 1,
          "gh_diff_tests_added": 0,
          "gh_diff_tests_deleted": 0,
          "gh_diff_src_files": 0,
          "gh_diff_doc_files": 0,
          "gh_diff_other_files": 1,
          "gh_num_commits_on_files_touched": 2,
          "gh_sloc": 75,
          "gh_test_lines_per_kloc": 0,
          "gh_test_cases_per_kloc": 0,
          "gh_asserts_cases_per_kloc": 0,
          "gh_by_core_team_member": true,
          "gh_repo_age": 209.21,
          "gh_repo_num_commits": 8,
          "build_duration": 167,
          "build_failed": "passed",
          "gh_build_started_at": "12/14/2024 11:21:45"
        },
        {
          "_id": "680e63cd9e247d8fde8df70e",
          "git_branch": "main",
          "git_all_built_commits": "cfa69d79df3c5d83df05f6fe2bd4db22783c7b5f",
          "git_num_all_built_commits": 1,
          "git_trigger_commit": "cfa69d79df3c5d83df05f6fe2bd4db22783c7b5f",
          "git_diff_src_churn": 0,
          "git_diff_test_churn": 0,
          "gh_project_name": "NT548-P11-DevOps-Technology/class-management-lecturer-service",
          "gh_is_pr": false,
          "gh_lang": "python",
          "gh_team_size": 1,
          "gh_num_issue_comments": 0,
          "gh_num_pr_comments": 0,
          "gh_num_commit_comments": 0,
          "gh_diff_files_added": 1,
          "gh_diff_files_deleted": 0,
          "gh_diff_files_modified": 0,
          "gh_diff_tests_added": 0,
          "gh_diff_tests_deleted": 0,
          "gh_diff_src_files": 0,
          "gh_diff_doc_files": 0,
          "gh_diff_other_files": 1,
          "gh_num_commits_on_files_touched": 1,
          "gh_sloc": 75,
          "gh_test_lines_per_kloc": 0,
          "gh_test_cases_per_kloc": 0,
          "gh_asserts_cases_per_kloc": 0,
          "gh_by_core_team_member": true,
          "gh_repo_age": 209.12,
          "gh_repo_num_commits": 7,
          "build_duration": 228,
          "build_failed": "passed",
          "gh_build_started_at": "12/14/2024 09:01:41"
        }
      ]
    }

    # Call endpoint
    response = client.post("/predict", json=input_data)

    # Assertions
    assert response.status_code == 200, "Prediction endpoint failed"
    assert "prediction" in response.json(), "Prediction key missing"
    assert isinstance(response.json()["prediction"], list), "Prediction is not a list"


def test_health_endpoint():
    response = client.get("/health")
    assert response.status_code == 200
    assert response.json() == {"status": "healthy"}